image: ghcr.io/astral-sh/uv:python3.11-bookworm

stages:
  - lint
  - test
  - security
  - build
  - release

variables:
  UV_LINK_MODE: "copy"
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"

cache:
  key: "$CI_COMMIT_REF_SLUG"
  paths:
    - .venv/
    - .cache/uv/
    - .cache/pip/

# Lint stage
lint:
  stage: lint
  script:
    - uv venv
    - source .venv/bin/activate
    - uv pip install -e .[dev]
    - echo "Running ruff..."
    - ruff check .
    - echo "Running mypy..."
    - mypy src
    - echo "Checking formatting..."
    - black --check .
    - isort --check-only .
  artifacts:
    reports:
      codequality: gl-code-quality-report.json
    when: always
  rules:
    - if: $CI_PIPELINE_SOURCE == "push" || $CI_PIPELINE_SOURCE == "merge_request_event"

# Test stage with coverage
test:
  stage: test
  script:
    - uv venv
    - source .venv/bin/activate
    - uv pip install -e .[dev]
    - echo "Running tests with coverage..."
    - pytest --cov=src --cov-report=term-missing --cov-report=xml --cov-report=html --junitxml=junit.xml
    - echo "Coverage report:"
    - coverage report
  coverage: '/(?i)total.*? (100(?:\.0+)?\%|[1-9]?\d(?:\.\d+)?\%)$/'
  artifacts:
    when: always
    reports:
      junit: junit.xml
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
    paths:
      - htmlcov/
    expire_in: 30 days
  rules:
    - if: $CI_PIPELINE_SOURCE == "push" || $CI_PIPELINE_SOURCE == "merge_request_event"

# Security scanning - detect leaked credentials  # pragma: allowlist secret
security_secrets:  # pragma: allowlist secret
  stage: security
  script:
    - echo "Scanning for leaked credentials with gitleaks..."  # pragma: allowlist secret
    - uvx gitleaks detect --no-git -v --report-path gl-secret-detection-report.json || true  # pragma: allowlist secret
  artifacts:
    reports:
      secret_detection: gl-secret-detection-report.json  # pragma: allowlist secret
    when: always
  allow_failure: true
  rules:
    - if: $CI_PIPELINE_SOURCE == "push" || $CI_PIPELINE_SOURCE == "merge_request_event"

security_sast:
  stage: security
  script:
    - echo "Running bandit security scan..."
    - uvx bandit -r src -f json -o gl-sast-report.json || true
    - uvx bandit -r src -q
  artifacts:
    reports:
      sast: gl-sast-report.json
    when: always
  allow_failure: true
  rules:
    - if: $CI_PIPELINE_SOURCE == "push" || $CI_PIPELINE_SOURCE == "merge_request_event"

security_dependencies:
  stage: security
  script:
    - uv venv
    - source .venv/bin/activate
    - uv pip install -e .[dev]
    - echo "Checking for known vulnerabilities..."
    - uvx safety check --json || true
  allow_failure: true
  rules:
    - if: $CI_PIPELINE_SOURCE == "push" || $CI_PIPELINE_SOURCE == "merge_request_event"

# Build Docker image
build_image:
  stage: build
  image: gcr.io/kaniko-project/executor:latest
  script:
    - mkdir -p /kaniko/.docker
    - echo "{\"auths\":{\"ghcr.io\":{\"username\":\"$GHCR_USERNAME\",\"password\":\"$GHCR_TOKEN\"}}}" > /kaniko/.docker/config.json
    - >
      /kaniko/executor
      --context $CI_PROJECT_DIR
      --dockerfile $CI_PROJECT_DIR/Dockerfile
      --destination ghcr.io/$GHCR_USERNAME/policy-rag-agent:${CI_COMMIT_TAG}
      --destination ghcr.io/$GHCR_USERNAME/policy-rag-agent:latest
      --cache=true
      --cache-ttl=24h
      --build-arg BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
      --build-arg VCS_REF=${CI_COMMIT_SHA}
      --build-arg VERSION=${CI_COMMIT_TAG}
  rules:
    - if: $CI_COMMIT_TAG

# Container scanning
scan_image:
  stage: security
  image: aquasec/trivy:latest
  script:
    - echo "Scanning Docker image for vulnerabilities..."
    - trivy image --exit-code 0 --no-progress ghcr.io/$GHCR_USERNAME/policy-rag-agent:${CI_COMMIT_TAG}
  dependencies:
    - build_image
  allow_failure: true
  rules:
    - if: $CI_COMMIT_TAG

# Release documentation
release:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  script:
    - echo "Creating release for $CI_COMMIT_TAG"
  release:
    tag_name: '$CI_COMMIT_TAG'
    description: 'Release $CI_COMMIT_TAG'
  rules:
    - if: $CI_COMMIT_TAG
